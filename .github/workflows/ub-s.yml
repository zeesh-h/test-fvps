name: Ubuntu-SSH

on:
  workflow_dispatch:

jobs:
  kali-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Generate SSH Keys and Secure Password
        run: |
          # Generate secure random password
          SSH_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
          echo "SSH_PASSWORD=$SSH_PASSWORD" >> $GITHUB_ENV
          echo "Password generated successfully"

      - name: Setup SSH config
        run: |
          # 1. Create the user
          sudo useradd -m -s /bin/bash -G sudo test
          
          # 2. Set password - FIXED: Added 'sudo' before chpasswd
          echo "test:${{ env.SSH_PASSWORD }}" | sudo chpasswd
          
          # 3. Configure SSH Daemon
          # We use generic replacements to ensure we catch the config lines
          sudo sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          # Ensure it's set even if it wasn't commented out
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          
          # 4. Start SSH Service - FIXED: Used 'service start' instead of 'sshd -D'
          # 'sshd -D' runs in the foreground and blocks the rest of the script.
          sudo service ssh start
          
          # Wait for SSH to be ready
          sleep 10

      - name: Install Tailscale on Host
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-kali-${{ github.run_id }} --accept-routes
          
          # Wait for Tailscale to assign an IP
          TAILSCALE_IP=""
          retries=0
          while [ -z "$TAILSCALE_IP" ] && [ $retries -lt 10 ]; do
            TAILSCALE_IP=$(tailscale ip -4)
            sleep 5
            retries=$((retries + 1))
          done
          
          if [ -z "$TAILSCALE_IP" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TAILSCALE_IP"

      - name: Verify SSH Accessibility
        run: |
          echo "Testing SSH connectivity..."
          # Verify the service is actually running
          sudo service ssh status
          
          # Test SSH port
          timeout 10 bash -c "cat < /dev/null > /dev/tcp/localhost/22" && echo "SSH port accessible" || echo "SSH port test failed"

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== Ubuntu SSH ACCESS ==="
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "SSH Command: ssh test@${{ env.TAILSCALE_IP }}"
          echo "Username: test"
          echo "Password: ${{ env.SSH_PASSWORD }}"
          echo "======================="
          echo ""
          
          # Keep runner active
          while true; do
            echo "[$(date)] Ubuntu SSH Active - Use Actions UI to cancel workflow"
            sleep 300
          done
