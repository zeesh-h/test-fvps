name: Kali-SSH

on:
  workflow_dispatch:

jobs:
  kali-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Pull Kali Linux Docker Image
        run: |
          docker pull kalilinux/kali-rolling
          
      - name: Generate SSH Keys and Secure Password
        run: |
          # Generate SSH host keys
          mkdir -p ~/.ssh-host-keys
          ssh-keygen -A -f ~/.ssh-host-keys
          
          # Generate secure random password
          SSH_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
          echo "SSH_PASSWORD=$SSH_PASSWORD" >> $GITHUB_ENV
          echo "Password generated successfully"

      - name: Start Kali Container with SSH
        run: |
          docker run -d \
            --name kali-ssh \
            --cap-add=NET_ADMIN \
            --cap-add=SYS_MODULE \
            --device=/dev/net/tun \
            -v ~/.ssh-host-keys:/etc/ssh-host-keys \
            kalilinux/kali-rolling \
            /bin/bash -c "
              apt update && \
              DEBIAN_FRONTEND=noninteractive apt install -y openssh-server curl sudo && \
              mkdir -p /run/sshd && \
              useradd -m -s /bin/bash -G sudo kali && \
              echo 'kali:${{ env.SSH_PASSWORD }}' | chpasswd && \
              sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
              sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
              echo 'AllowUsers kali' >> /etc/ssh/sshd_config && \
              /usr/sbin/sshd -D
            "
          
          # Wait for SSH to be ready
          sleep 10

      - name: Get Container IP
        run: |
          CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' kali-ssh)
          echo "CONTAINER_IP=$CONTAINER_IP" >> $GITHUB_ENV
          echo "Container IP: $CONTAINER_IP"

      - name: Install Tailscale on Host
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          
      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-kali-${{ github.run_id }} --accept-routes
          
          # Wait for Tailscale to assign an IP
          TAILSCALE_IP=""
          retries=0
          while [ -z "$TAILSCALE_IP" ] && [ $retries -lt 10 ]; do
            TAILSCALE_IP=$(tailscale ip -4)
            sleep 5
            retries=$((retries + 1))
          done
          
          if [ -z "$TAILSCALE_IP" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TAILSCALE_IP"

      - name: Setup SSH Port Forwarding
        run: |
          # Forward SSH from host to container
          sudo iptables -t nat -A PREROUTING -p tcp --dport 22 -j DNAT --to-destination ${{ env.CONTAINER_IP }}:22
          sudo iptables -t nat -A POSTROUTING -j MASQUERADE
          
          # Enable IP forwarding
          sudo sysctl -w net.ipv4.ip_forward=1

      - name: Verify SSH Accessibility
        run: |
          echo "Testing SSH connectivity..."
          
          # Test SSH port
          timeout 10 bash -c "cat < /dev/null > /dev/tcp/localhost/22" && echo "SSH port accessible" || echo "SSH port test failed"

      - name: Install Common Kali Tools (Optional)
        run: |
          docker exec kali-ssh bash -c "
            DEBIAN_FRONTEND=noninteractive apt install -y \
              kali-linux-core \
              nmap \
              metasploit-framework \
              wireshark \
              john \
              hydra \
              sqlmap \
              netcat-traditional \
              tcpdump \
              git \
              vim \
              tmux
          " || echo "Tool installation completed with warnings"

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== KALI SSH ACCESS ==="
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "SSH Command: ssh kali@${{ env.TAILSCALE_IP }}"
          echo "Username: kali"
          echo "Password: ${{ env.SSH_PASSWORD }}"
          echo "======================="
          echo ""
          
          # Keep runner active
          while true; do
            echo "[$(date)] Kali SSH Active - Use Actions UI to cancel workflow"
            
            # Check if container is still running
            if ! docker ps | grep -q kali-ssh; then
              echo "Container stopped. Restarting..."
              docker start kali-ssh
            fi
            
            sleep 300
          done
